<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Threat Mitigation Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #059669; /* Green 600 */
            --primary-light-color: #D1FAE5; /* Green 100 */
            --primary-border-color: #10B981; /* Green 500 */
            --primary-ring-color: #34D399; /* Green 400 */
        }

        body {
            font-family: 'Inter', sans-serif;
            padding-bottom: 80px;
        }
        .hidden { display: none; }

        /* Stepper styles */
        .stepper-item { @apply flex items-center justify-center w-8 h-8 rounded-full border-2; }
        .stepper-item.active { background-color: var(--primary-color); border-color: var(--primary-color); @apply text-white; }
        .stepper-item.completed { background-color: var(--primary-color); border-color: var(--primary-color); @apply text-white; }
        .stepper-item.inactive { @apply border-gray-300 bg-white; }
        .stepper-line { @apply w-16 h-0.5 bg-gray-300; }

        /* Selection styles */
        .upgrade-item.selected {
            background-color: var(--primary-light-color);
            border-color: var(--primary-border-color);
            box-shadow: 0 0 0 2px var(--primary-ring-color);
        }
        .color-swatch.selected {
            transform: scale(1.1);
            box-shadow: 0 0 0 3px white, 0 0 0 5px var(--primary-color);
        }
        
        /* Theme-aware classes */
        .theme-bg-primary { background-color: var(--primary-color); }
        .theme-bg-light { background-color: var(--primary-light-color); }
        .theme-text-primary { color: var(--primary-color); }
        .theme-border-primary { border-color: var(--primary-color); }
        .theme-focus-ring:focus {
            --tw-ring-color: var(--primary-ring-color);
            box-shadow: 0 0 0 2px var(--tw-ring-color);
            border-color: var(--primary-border-color);
        }
        .theme-checkbox:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .theme-radio:checked {
             background-color: var(--primary-color);
             border-color: var(--primary-color);
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto bg-white shadow-lg rounded-lg p-4 sm:p-8">

        <!-- Header -->
        <header class="flex justify-between items-center pb-4 border-b mb-6">
             <div class="flex items-center space-x-4">
                <svg id="header-logo" width="40" height="40" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect width="100" height="100" rx="8" fill="var(--primary-color)"/>
                </svg>
                <div class="flex items-center space-x-2">
                    <span class="text-xl font-bold text-gray-800">climative</span>
                    <span class="text-xl font-light text-gray-500">Navigator</span>
                </div>
            </div>
            <button class="sm-hidden">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </header>

        <main id="app-container">

            <!-- Step 0: Initial Choice -->
            <div id="step-0" class="text-center">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">Understand and Mitigate Your Home's Threats</h1>
                <p class="text-gray-600 mb-8">Get a free, personalized plan to protect your home from physical and financial risks.</p>
                <button onclick="showStep(1)" class="theme-bg-primary w-full text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:-translate-y-1">
                    Get My Free Home Report
                </button>
                <div class="mt-8 pt-6 border-t">
                    <p class="text-sm text-gray-500 mb-4">Choose a theme color</p>
                    <div id="color-selector" class="flex justify-center gap-3">
                        <div onclick="setTheme('blue')" class="color-swatch h-8 w-8 rounded-full cursor-pointer bg-blue-600 transition-transform"></div>
                        <div onclick="setTheme('red')" class="color-swatch h-8 w-8 rounded-full cursor-pointer bg-red-600 transition-transform"></div>
                        <div onclick="setTheme('green')" class="color-swatch h-8 w-8 rounded-full cursor-pointer bg-green-600 transition-transform"></div>
                        <div onclick="setTheme('purple')" class="color-swatch h-8 w-8 rounded-full cursor-pointer bg-purple-600 transition-transform"></div>
                        <div onclick="setTheme('orange')" class="color-swatch h-8 w-8 rounded-full cursor-pointer bg-orange-600 transition-transform"></div>
                        <div onclick="setTheme('yellow')" class="color-swatch h-8 w-8 rounded-full cursor-pointer bg-yellow-500 transition-transform"></div>
                    </div>
                </div>
            </div>

            <!-- Step 1: Find Address -->
            <div id="step-1" class="hidden text-center">
                <div class="flex justify-center items-center mb-6">
                    <div class="stepper-item active">1</div><div class="stepper-line"></div><div class="stepper-item inactive">2</div><div class="stepper-line"></div><div class="stepper-item inactive">3</div>
                </div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Get Your Home Threat Report</h1>
                <p class="text-gray-600 mb-6">Search your address for a free personalized report and mitigation plan.</p>
                <div class="bg-gray-50 p-6 rounded-lg">
                    <div class="relative">
                        <input type="text" placeholder="Search Your Address" class="theme-focus-ring w-full p-3 border border-gray-300 rounded-lg">
                        <button onclick="showStep(2)" class="theme-text-primary absolute right-3 top-1/2 -translate-y-1/2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                    </div>
                </div>
                 <p class="text-sm text-gray-500 mt-8">Already Have an Account? <a href="#" onclick="showStep(4)" class="theme-text-primary font-semibold">Sign In Here</a></p>
            </div>

            <!-- Step 2: Confirm Address -->
            <div id="step-2" class="hidden text-center">
                 <div class="flex justify-center items-center mb-6">
                    <div class="stepper-item completed">âœ“</div><div class="stepper-line"></div><div class="stepper-item active">2</div><div class="stepper-line"></div><div class="stepper-item inactive">3</div>
                </div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Confirm Address</h1>
                <p class="text-gray-600 mb-8">This will allow us to populate any publicly available information for your home.</p>
                <div class="bg-gray-100 p-6 rounded-lg border border-gray-200">
                    <p class="font-semibold text-gray-800">801 Rue Mitchell, Fredericton, New Brunswick E3B 6E8, Canada</p>
                </div>
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button onclick="showStep(3)" class="theme-bg-primary w-full text-white font-semibold py-3 px-6 rounded-lg">YES, THIS IS MY ADDRESS</button>
                    <button onclick="showStep(1)" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg">CHANGE ADDRESS</button>
                </div>
            </div>

            <!-- Step 3: Choose Location on Map -->
            <div id="step-3" class="hidden text-center">
                <div class="flex justify-center items-center mb-6">
                    <div class="stepper-item completed">âœ“</div><div class="stepper-line"></div><div class="stepper-item completed">âœ“</div><div class="stepper-line"></div><div class="stepper-item active">3</div>
                </div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Choose Location on Map</h1>
                <p class="text-gray-600 mb-6">This helps us get the most accurate information for your specific location.</p>
                 <div class="relative rounded-lg overflow-hidden shadow-lg">
                    <img src="https://placehold.co/400x300/374151/D1D5DB?text=3D+Map+View&font=inter" alt="Map" class="w-full">
                    <div class="absolute bottom-0 left-0 right-0 bg-white p-4 m-4 rounded-lg shadow-xl">
                         <div class="flex gap-2">
                            <button onclick="showStep(5)" class="theme-bg-primary flex-1 text-white text-sm font-semibold py-2 px-4 rounded-lg">YES, THIS IS MY HOME</button>
                            <button onclick="showStep(2)" class="flex-1 bg-gray-200 text-gray-700 text-sm font-semibold py-2 px-4 rounded-lg">NO, SOMETHING'S NOT RIGHT</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Sign In -->
            <div id="step-4" class="hidden">
                 <div class="text-center"><h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-8">Sign In</h1></div>
                <form action="#" onsubmit="event.preventDefault(); showStep(5);">
                    <div class="space-y-4">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" class="theme-focus-ring mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" class="theme-focus-ring mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                        <button type="submit" class="theme-bg-primary w-full text-white font-bold py-3 px-6 rounded-lg">SIGN IN</button>
                    </div>
                </form>
            </div>

            <!-- Step 5: Unified Report -->
            <div id="step-5" class="hidden">
                <h1 class="text-2xl font-bold text-gray-800 mb-4">Home Threat Report</h1>
                <div class="text-sm text-gray-500 mb-4 border-b pb-4">
                    <p>801 RUE MITCHELL STREET, FREDERICTON</p>
                </div>
                 <button onclick="showStep(6)" class="w-full theme-bg-light theme-text-primary font-semibold py-3 px-6 rounded-lg hover:opacity-80 transition mb-6">Personalize My Report</button>
                
                <div id="threat-report-container" class="bg-white border rounded-lg p-4 sm:p-6 mb-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">Threat assessment for your home:</h2>
                    <!-- Threats will be dynamically inserted here -->
                </div>
                
                <!-- Teaser Section -->
                <div id="teaser-section" class="space-y-4 mb-6">
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
                        <p class="text-gray-700">Your current energy use is <span class="font-bold">181 GJ/year</span>.</p>
                        <p class="text-gray-700">We can help you reduce it by up to <span id="energy-reduction-teaser" class="font-bold theme-text-primary text-lg">30%</span>.</p>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
                        <p class="text-gray-700">Your home has a <span class="font-bold text-red-600">High</span> overall physical threat level.</p>
                        <p class="text-gray-700">We can help you reduce it by up to <span id="threat-reduction-teaser" class="font-bold theme-text-primary text-lg">70%</span>.</p>
                    </div>
                </div>

                <button onclick="showStep(7)" class="w-full bg-gray-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition">Open Project Builder to See How</button>
            </div>
            
            <!-- Step 6: Questionnaire -->
            <div id="step-6" class="hidden">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Tell us more about your home</h1>
                <form id="questionnaire-form" class="space-y-4 text-left">
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Do you have a sump pump?</label>
                        <div class="mt-2 flex gap-x-6"><label><input type="radio" name="sumpPump" value="yes" class="theme-radio"> Yes</label><label><input type="radio" name="sumpPump" value="no" class="theme-radio" checked> No</label></div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Do you have a float switch?</label>
                        <div class="mt-2 flex gap-x-6"><label><input type="radio" name="floatSwitch" value="yes" class="theme-radio"> Yes</label><label><input type="radio" name="floatSwitch" value="no" class="theme-radio" checked> No</label></div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Do you have a water level alarm?</label>
                        <div class="mt-2 flex gap-x-6"><label><input type="radio" name="waterAlarm" value="yes" class="theme-radio"> Yes</label><label><input type="radio" name="waterAlarm" value="no" class="theme-radio" checked> No</label></div>
                    </div>
                    <div>
                        <label for="roof-material" class="block text-sm font-medium text-gray-700">What is your roof material?</label>
                        <select id="roof-material" name="roofMaterial" class="theme-focus-ring mt-1 block w-full p-2 border-gray-300 rounded-md">
                            <option>Shingles</option><option>Steel</option><option>Poly</option><option value="hail_resistant">Hail Resistant</option>
                        </select>
                    </div>
                     <div>
                        <label for="siding-material" class="block text-sm font-medium text-gray-700">What is your siding material?</label>
                        <select id="siding-material" name="sidingMaterial" class="theme-focus-ring mt-1 block w-full p-2 border-gray-300 rounded-md">
                            <option>Vinyl</option><option>Wood</option><option>Aluminum</option><option value="fire_resistant">Hardiplank (Fire Resistant)</option>
                        </select>
                    </div>
                     <div>
                        <label for="window-type" class="block text-sm font-medium text-gray-700">What type of windows do you have?</label>
                        <select id="window-type" name="windowType" class="theme-focus-ring mt-1 block w-full p-2 border-gray-300 rounded-md">
                            <option>Vinyl</option><option>Wood Frame</option><option>Aluminum</option>
                        </select>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Have you ever done window or door upgrades?</label>
                        <div class="mt-2 flex gap-x-6"><label><input type="radio" name="doorUpgrades" value="yes" class="theme-radio"> Yes</label><label><input type="radio" name="doorUpgrades" value="no" class="theme-radio" checked> No</label></div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Have you had an insurance claim recently?</label>
                        <div class="mt-2 flex gap-x-6"><label><input type="radio" name="insuranceClaim" value="yes" class="theme-radio"> Yes</label><label><input type="radio" name="insuranceClaim" value="no" class="theme-radio" checked> No</label></div>
                    </div>
                    <div>
                        <label for="claim-type" class="block text-sm font-medium text-gray-700">If yes, what was it for?</label>
                        <select id="claim-type" name="claimType" class="theme-focus-ring mt-1 block w-full p-2 border-gray-300 rounded-md">
                            <option>N/A</option><option>Flood</option><option>Fire</option><option>Wind Damage</option><option>Other</option>
                        </select>
                    </div>
                    <button type="button" onclick="submitQuestionnaire()" class="w-full theme-bg-primary text-white font-bold py-3 px-6 rounded-lg mt-6">Update My Report</button>
                </form>
            </div>
            
            <!-- Step 7: Project Builder Landing -->
            <div id="step-7" class="hidden text-center">
                 <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">Project Builder</h1>
                <p class="text-gray-600 mb-6">Plan your mitigation strategy by selecting upgrades to see their impact on your threat levels and finances.</p>
                <button id="enter-builder-btn" class="theme-bg-primary w-full mt-6 text-white font-bold py-3 px-6 rounded-lg" onclick="showStep(8)">
                    Start Building
                </button>
            </div>

            <!-- Step 8: Project Builder Page -->
            <div id="step-8" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold text-gray-800">Project Builder</h1>
                    <a href="#" onclick="showStep(5)" class="theme-text-primary font-semibold hover:underline text-sm">Back to Report</a>
                 </div>
                 
                 <div class="bg-white border rounded-lg p-4 sm:p-6 mb-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">Project Impact Summary</h2>
                    <div id="builder-summary-container" class="space-y-3">
                        <!-- Dynamic summary will be inserted here -->
                    </div>
                    <div class="grid grid-cols-2 gap-4 pt-4 mt-4 border-t">
                         <div class="text-center"><p class="text-sm text-gray-600">Total Est. Cost</p><p id="summary-cost" class="text-xl font-bold text-gray-800">$0</p></div>
                         <div class="text-center"><p class="text-sm text-gray-600">20-Year Energy Savings</p><p id="summary-savings" class="text-xl font-bold text-green-600">$0</p></div>
                    </div>
                 </div>

                 <div class="space-y-6">
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-2">Pick upgrades to reduce threats</h3>
                        <div id="mitigations-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-center text-xs text-gray-600">
                             <!-- Mitigations will be inserted here -->
                        </div>
                    </div>
                 </div>
            </div>

        </main>
    </div>
    
    <!-- Floating Navigation -->
    <div id="navigation-buttons" class="fixed bottom-0 left-0 right-0 bg-white p-4 border-t shadow-lg flex justify-center gap-4">
        <button id="btn-back" onclick="goBack()" class="py-2 px-6 bg-gray-300 text-gray-800 font-semibold rounded-lg">Back</button>
        <button id="btn-forward" onclick="goNext()" class="theme-bg-primary py-2 px-6 text-white font-semibold rounded-lg">Next</button>
    </div>

    <script>
        let currentStep = 0;
        let historyStack = [0];

        // --- Data Models ---
        const initialThreats = {
            flood: { name: 'Flood', level: 8, selected: false },
            wildfire: { name: 'Wildfire', level: 5, selected: false },
            hail: { name: 'Hail', level: 9, selected: false },
            energy: { name: 'Rising Energy Prices', level: 7, selected: false, usage: 181 }
        };

        const mitigations = {
            'sump-pump': { name: 'Install Sump Pump', threats: { flood: -4 }, cost: 1500, savings: 100, selected: false },
            'drainage': { name: 'Improve Yard Drainage', threats: { flood: -2 }, cost: 2000, savings: 0, selected: false },
            'siding': { name: 'Fire-Resistant Siding', threats: { wildfire: -3 }, cost: 8000, savings: 200, selected: false },
            'roofing': { name: 'Hail-Resistant Roofing', threats: { hail: -7 }, cost: 10000, savings: 300, selected: false },
            'heat-pump': { name: 'Mini-Split Heat Pump', threats: { energy: -3 }, cost: 6000, savings: 3000, usageReduction: 40, selected: false },
            'air-sealing': { name: 'Air Sealing', threats: { energy: -2 }, cost: 800, savings: 1500, usageReduction: 15, selected: false },
            'insulation': { name: 'Attic Insulation', threats: { energy: -2 }, cost: 2500, savings: 2000, usageReduction: 25, selected: false }
        };

        let currentThreats = JSON.parse(JSON.stringify(initialThreats));

        // --- Theming ---
        const colorThemes = {
            red: { 100: '#FEE2E2', 400: '#F87171', 500: '#EF4444', 600: '#DC2626' },
            blue: { 100: '#DBEAFE', 400: '#60A5FA', 500: '#3B82F6', 600: '#2563EB' },
            green: { 100: '#D1FAE5', 400: '#34D399', 500: '#10B981', 600: '#059669' },
            purple: { 100: '#EDE9FE', 400: '#A78BFA', 500: '#8B5CF6', 600: '#7C3AED' },
            orange: { 100: '#FFEDD5', 400: '#FB923C', 500: '#F97316', 600: '#EA580C' },
            yellow: { 100: '#FEF9C3', 400: '#FACC15', 500: '#EAB308', 600: '#CA8A04' }
        };

        function setTheme(colorName) {
            const theme = colorThemes[colorName];
            const root = document.documentElement;
            root.style.setProperty('--primary-color', theme[600]);
            root.style.setProperty('--primary-light-color', theme[100]);
            root.style.setProperty('--primary-border-color', theme[500]);
            root.style.setProperty('--primary-ring-color', theme[400]);
            
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            const swatchElement = document.querySelector(`.bg-${colorName}-600`) || document.querySelector(`.bg-${colorName}-500`);
            if (swatchElement) {
                swatchElement.classList.add('selected');
            }
        }

        // --- UI Rendering ---
        function getThreatLevel(level) {
            if (level <= 4) return { text: 'Low', color: 'text-green-600', bg: 'bg-green-500' };
            if (level <= 7) return { text: 'Medium', color: 'text-yellow-600', bg: 'bg-yellow-500' };
            return { text: 'High', color: 'text-red-600', bg: 'bg-red-500' };
        }

        function renderThreats(containerId, threatsData) {
            const container = document.getElementById(containerId);
            container.innerHTML = ' <h2 class="text-lg font-bold text-gray-800 mb-4">Threat Assessment:</h2>';
            for (const key in threatsData) {
                const threat = threatsData[key];
                const levelInfo = getThreatLevel(threat.level);
                const threatHTML = `
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-semibold text-gray-700">${threat.name}</span>
                            <span class="text-sm font-bold ${levelInfo.color}">${levelInfo.text}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="${levelInfo.bg} h-2.5 rounded-full" style="width: ${threat.level * 10}%"></div>
                        </div>
                    </div>`;
                container.innerHTML += threatHTML;
            }
        }

        function renderMitigations() {
            const container = document.getElementById('mitigations-container');
            container.innerHTML = '';
            for (const key in mitigations) {
                const mitigation = mitigations[key];
                const mitigationHTML = `
                    <div id="mitigation-${key}" class="upgrade-item flex flex-col items-center p-2 rounded-lg border-2 border-gray-200 cursor-pointer bg-white">
                        <span class="text-xl mb-1">${getIconForMitigation(key)}</span>
                        <span>${mitigation.name}</span>
                    </div>`;
                container.innerHTML += mitigationHTML;
            }
            // Add event listeners after rendering
            for (const key in mitigations) {
                 document.getElementById(`mitigation-${key}`).addEventListener('click', () => toggleMitigation(key));
            }
        }
        
        function getIconForMitigation(key) {
            const icons = { 'sump-pump': 'ðŸ’§', 'drainage': 'ðŸŒ¿', 'siding': 'ðŸ”¥', 'roofing': 'ðŸ ', 'heat-pump': 'â„ï¸', 'air-sealing': 'ðŸ’¨', 'insulation': 'ðŸ§±' };
            return icons[key] || 'ðŸ”§';
        }

        // --- Logic & State Updates ---
        function calculateAndDisplayTeaser() {
            // Energy Teaser
            const totalEnergyReduction = Object.values(mitigations)
                .filter(m => m.usageReduction)
                .reduce((sum, m) => sum + m.usageReduction, 0);
            const energyReductionPercent = Math.round((totalEnergyReduction / initialThreats.energy.usage) * 100);
            document.getElementById('energy-reduction-teaser').textContent = `${energyReductionPercent}%`;

            // Physical Threat Teaser
            let initialPhysicalThreat = 0;
            let potentialPhysicalThreat = 0;
            const physicalThreatKeys = ['flood', 'wildfire', 'hail'];

            physicalThreatKeys.forEach(key => {
                initialPhysicalThreat += initialThreats[key].level;
                let finalLevel = initialThreats[key].level;
                Object.values(mitigations).forEach(m => {
                    if (m.threats[key]) {
                        finalLevel += m.threats[key];
                    }
                });
                potentialPhysicalThreat += Math.max(0, finalLevel);
            });
            
            const threatReductionPercent = initialPhysicalThreat > 0 
                ? Math.round(((initialPhysicalThreat - potentialPhysicalThreat) / initialPhysicalThreat) * 100)
                : 0;
            document.getElementById('threat-reduction-teaser').textContent = `${threatReductionPercent}%`;
        }

        function submitQuestionnaire() {
            const form = document.getElementById('questionnaire-form');
            const hasSumpPump = form.elements.sumpPump.value === 'yes';
            const hasHailRoof = form.elements.roofMaterial.value === 'hail_resistant';
            const hasFireSiding = form.elements.sidingMaterial.value === 'fire_resistant';

            currentThreats = JSON.parse(JSON.stringify(initialThreats));

            if (hasSumpPump) currentThreats.flood.level = Math.max(0, currentThreats.flood.level + mitigations['sump-pump'].threats.flood);
            if (hasHailRoof) currentThreats.hail.level = Math.max(0, currentThreats.hail.level + mitigations['roofing'].threats.hail);
            if (hasFireSiding) currentThreats.wildfire.level = Math.max(0, currentThreats.wildfire.level + mitigations['siding'].threats.wildfire);
            
            showStep(5);
        }

        function updateBuilderSummary() {
            let projectedThreats = JSON.parse(JSON.stringify(currentThreats));
            let totalCost = 0;
            let totalSavings = 0;

            for (const key in mitigations) {
                if (mitigations[key].selected) {
                    totalCost += mitigations[key].cost;
                    totalSavings += mitigations[key].savings;
                    for (const threatKey in mitigations[key].threats) {
                        projectedThreats[threatKey].level = Math.max(0, projectedThreats[threatKey].level + mitigations[key].threats[threatKey]);
                    }
                }
            }
            
            renderThreats('builder-summary-container', projectedThreats);
            document.getElementById('summary-cost').textContent = `$${totalCost.toLocaleString()}`;
            document.getElementById('summary-savings').textContent = `$${totalSavings.toLocaleString()}`;
        }

        function toggleMitigation(mitigationKey) {
            mitigations[mitigationKey].selected = !mitigations[mitigationKey].selected;
            document.getElementById(`mitigation-${mitigationKey}`).classList.toggle('selected');
            updateBuilderSummary();
        }

        // --- Navigation ---
        const mainFlowSequence = [0, 1, 2, 3, 5, 7, 8];

        function showStep(stepNumber) {
            document.querySelectorAll('#app-container > div').forEach(step => step.classList.add('hidden'));
            document.getElementById(`step-${stepNumber}`).classList.remove('hidden');
            
            currentStep = stepNumber;
            if (historyStack[historyStack.length - 1] !== stepNumber) {
                historyStack.push(stepNumber);
            }
            
            if (stepNumber === 5) {
                renderThreats('threat-report-container', currentThreats);
                calculateAndDisplayTeaser();
            }
            if (stepNumber === 8) {
                Object.values(mitigations).forEach(m => m.selected = false);
                renderMitigations();
                updateBuilderSummary();
            }
            
            updateNavButtons();
        }

        function goNext() {
            const currentIndex = mainFlowSequence.indexOf(currentStep);
            if (currentIndex !== -1 && currentIndex < mainFlowSequence.length - 1) {
                const nextStep = mainFlowSequence[currentIndex + 1];
                showStep(nextStep);
            }
        }

        function goBack() {
            if (historyStack.length <= 1) return;
            historyStack.pop();
            const previousStep = historyStack[historyStack.length - 1];
            currentStep = previousStep;
            document.querySelectorAll('#app-container > div').forEach(step => step.classList.add('hidden'));
            document.getElementById(`step-${currentStep}`).classList.remove('hidden');
            updateNavButtons();
        }
        
        function updateNavButtons() {
            const backButton = document.getElementById('btn-back');
            const forwardButton = document.getElementById('btn-forward');
            const navContainer = document.getElementById('navigation-buttons');

            if (currentStep === 0) {
                navContainer.classList.add('hidden');
                return;
            }
            navContainer.classList.remove('hidden');
            
            backButton.style.display = historyStack.length > 1 ? 'block' : 'none';

            const noForwardSteps = [4, 6, 8];
            const isLastStep = mainFlowSequence.indexOf(currentStep) === mainFlowSequence.length - 1;
            if (noForwardSteps.includes(currentStep) || isLastStep) {
                forwardButton.style.display = 'none';
            } else {
                forwardButton.style.display = 'block';
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setTheme('green');
            showStep(0);
        });

    </script>
</body>
</html>

